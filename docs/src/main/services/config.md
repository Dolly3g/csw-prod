# Configuration service

Configuration Service provides a centralized persistent store for any configuration file used in the TMT Software System. All versions of configuration files are retained providing a historical record of each configuration file.

This service will be part of observatory cluster and exposes Rest endpoints that can be accessed over HTTP. Component developers can use the csw-config-client library in their code. The library wraps the low level communication with ConfigServer and exposes simple to use methods to access and manage configuration files.  
 
## Artifacts

sbt
:   @@@vars
    ```scala
    libraryDependencies += "org.tmt" %% "csw-config_$scala.binaryVersion$" % "$version$"
    ```
    @@@

maven
:   @@@vars
    ```xml
    <dependency>
     <groupId>org.tmt</groupId>
     <artifactId>csw-config_$scala.binaryVersion$</artifactId>
     <version>$version$</version>
     <type>pom</type>
    </dependency>
    ```
    @@@

gradle
:   @@@vars
    ```gradle
    dependencies {
      compile group: "org.tmt", name: "csw-config_$scala.binaryVersion$", version: "$version$"
    }
    ```
    @@@

## Rules and checks
* The config file path must not contain `!#<>$%&'@^``~+,;=` or `any whitespace character`    
* If the input file is > 10MB or has lot of non ASCII characters, then for optimization, server will archive it in `annex` store.
* Large and binary files can be forced to go to 'annex' store by using a `annex=true` flag in `create` operation. 
* API functions accept date-time values in UTC timezone. (e.g. 2017-05-17T08:00:24.246Z) 

## Model classes
* **ConfigData** : Represents the contents of the files being managed. It wraps stream of ByteString.    
* **ConfigFileInfo** : Represents information about a config file stored in the config service.    
* **ConfigFileRevision** : Represents information about a specific version of a config file.    
* **ConfigId** : Represents identifier associated with a revision of configuration file, often generated by `create` or `update` methods.    
* **ConfigMetadata** : Represents metadata information about ConfigServer.    
* **FileType** : Represents the type of storage for a configuration file. Currently two types are supported `Normal`(small, text files) and `Annex`(Large, Binary files).
 
## API flavours

csw-config-client offers two APIs.

* **clientAPI** : Expected to be consumed by component developers. Available functions are: `{exists | getActive}`    
* **adminAPI**  : Full functionality exposed by ConfigServer is available with this API. Expected to be used administrators. Available functions are: `{create | update | getById | getLatest | getByTime | delete | list | history | historyActive | setActiveVersion | resetActiveVersion | getActiveVersion | getActiveByTime | getMetadata | exists | getActive}`

## Accessing clientAPI and adminAPI

ConfigClientFactory exposes functions to get clientAPI and adminAPI. Both the functions require LocationService instance which is used to resolve ConfigServer.

Scala
:   @@snip [ConfigClientDemoExample.scala](../../../../csw-config-client/src/test/scala/csw/services/config/client/scaladsl/demo/ConfigClientDemoExample.scala) { #create-api }

## exists

Function checks if the file exists at specified path in the repository. If it exists it returns Future of Boolean

Scala
:   @@snip [ConfigClientDemoExample.scala](../../../../csw-config-client/src/test/scala/csw/services/config/client/scaladsl/demo/ConfigClientDemoExample.scala) { #exists-snip1 #exists-snip2 }

## getActive

Function retrieves currently active file for a given path from config service. It returns a Future of Option of ConfigData.

Scala
:   @@snip [ConfigClientDemoExample.scala](../../../../csw-config-client/src/test/scala/csw/services/config/client/scaladsl/demo/ConfigClientDemoExample.scala) { #declare_string_config #getActive-snip1 #getActive-snip2 }

## create

Takes input ConfigData and creates the configuration in the repository at a specified path

Scala
:   @@snip [ConfigClientDemoExample.scala](../../../../csw-config-client/src/test/scala/csw/services/config/client/scaladsl/demo/ConfigClientDemoExample.scala) { #create }

## update

Takes input ConfigData and overwrites the configuration specified in the repository

Scala
:   @@snip [ConfigClientDemoExample.scala](../../../../csw-config-client/src/test/scala/csw/services/config/client/scaladsl/demo/ConfigClientDemoExample.scala) { #update }

## getById

Returns file at a given path and matching revision Id

Scala
:   @@snip [ConfigClientDemoExample.scala](../../../../csw-config-client/src/test/scala/csw/services/config/client/scaladsl/demo/ConfigClientDemoExample.scala) { #getById }

## getLatest

Returns the latest versio of file stored at the given path.

Scala
:   @@snip [ConfigClientDemoExample.scala](../../../../csw-config-client/src/test/scala/csw/services/config/client/scaladsl/demo/ConfigClientDemoExample.scala) { #getLatest }
